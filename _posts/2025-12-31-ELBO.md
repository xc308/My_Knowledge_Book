---
layout: post
title: "How to derive the Evidence Lower Bound (ELBO) for the variational diffusion training loss?"
math: true
date: 2025-12-31
---

To derive the Evidence Lower Bound (ELBO), we start from the training loss $L$. 
The explaination of this loss function $L$ can be found in [this post](https://xc308.github.io/What-Why-and-How-Generative-AI-Blogs/2025/12/31/Diffusion-Training-Loss.html).

$$
\begin{aligned}
L
&= \int q\!\left(x^{(0)}\right) \log p\!\left(x^{(0)}\right) \mathrm{d}x^{(0)} \\
&= \int q\!\left(x^{(0)}\right) \log\!\left[\int p\!\left(x^{(0,\ldots,T)}\right) \frac{q\!\left(x^{(1,\ldots,T)}\mid x^{(0)}\right)}{q\!\left(x^{(1,\ldots,T)} \mid x^{(0)}\right)} \mathrm{d}x^{(1,\ldots,T)} \right]\mathrm{d}x^{(0)} \\
&= \int q\!\left(x^{(0)}\right) \log\!\left[
\int q\!\left(x^{(1,\ldots,T)}\mid x^{(0)}\right)
\frac{p\!\left(x^{(0,\ldots,T)}\right)}{q\!\left(x^{(1,\ldots,T)}\mid x^{(0)}\right)}
\mathrm{d}x^{(1,\ldots,T)}
\right]\mathrm{d}x^{(0)}     \qquad   (1)
\end{aligned}
$$


In which, 
$$
q(x^{(1, \ldots, T)}| x^{(0)}) \times q(x^{(0)}) = q(x^{(0, \ldots, T)}) = q(x^{(0)}) \times \Pi_{t=1}^{T} q(x^{t} | x^{(t-1)}), \\
$$
therefore, 

$$
q(x^{(1, \ldots, T)}| x^{(0)}) = \Pi_{t=1}^{T} q(x^{t} | x^{(t-1)})     \qquad  (2)
$$

Similarly, 

$$
p(x^{0, \ldots, T}) = p(x^{T}) \! \Pi_{t = 1}^T p(x^{t-1} \mid x(t))    \qquad     (3)
$$

Since equation (1) requires integration over all the intermediate steps $\int dx^{(1, \ldots, T)}$ that could've generated the $x_0$, but these integrations are not analytical. 

So, by Jensen's inequality, we have 

$$
\begin{aligned}
\mathcal{L}
&\ge \int \mathrm{d}x^{(0)}\, q\!\left(x^{(0)}\right)
   \int \mathrm{d}x^{(1:T)}\, q\!\left(x^{(1:T)} \mid x^{(0)}\right)
   \log \frac{p\!\left(x^{(0:T)}\right)}{q\!\left(x^{(1:T)} \mid x^{(0)}\right)} \\
&= \int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)}\right)
   \log \frac{p\!\left(x^{(T)}\right)\prod_{t=1}^{T} p\!\left(x^{(t-1)} \mid x^{(t)}\right)}
                 {\prod_{t=1}^{T} q\!\left(x^{(t)} \mid x^{(t-1)}\right)} \\
&= \int \mathrm{d}x^{(T)}\, q\!\left(x^{(T)}\right)\, \log p\!\left(x^{(T)}\right) \\
&\quad + \int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)}\right)
   \sum_{t=2}^{T} \log \frac{p\!\left(x^{(t-1)} \mid x^{(t)}\right)}
                        {q\!\left(x^{(t)} \mid x^{(t-1)}\right)} \\
&\quad + \int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)}\right)
   \log \frac{p\!\left(x^{(0)} \mid x^{(1)}\right)}
                {q\!\left(x^{(1)} \mid x^{(0)}\right)}  \qquad (5).
\end{aligned}
$$

The first term is a negative cross-entropy of $x^{(T)}$, i.e., $- H_p(x^{T})$, and the third term is 0 as we assume $p(x^{(0)}) \mid x^{(1)} = p(x^{(1)} \mid x^{(0)})$.

The second term contains $p(x^{(t-1)} \mid x^{(t)})$ and $q(x^{(t)} \mid x^{(t-1)})$, which is hard to compare, so we leverage $x^{(0)}$ and Bayesian trick to rewrite the $q(x^{(t)} \mid x^{(t-1)})$ to $q(x^{(t-1)} \mid x^{(t)})$ as 

$$
q(x^{(t-1)} \mid x^{(t)}) = \frac{q(x^{(t-1)}) \mid x^{(t)}, x^{(0)} q(x^{(t)} \mid x^{(0)})}{ q(x^{(t-1)} \mid x^{(0)})} \qquad (6)
$$

Substituting (6) into (5), we get 

$$
\begin{aligned}
\mathcal{L}
&\ge - H_p(x^{(T)}) +  \int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)} \right)  \sum_{t=2}^{T} \log \frac{p\!\left(x^{(t-1)} \mid x^{(t)}\right)}{q\!\left(x^{(t-1)} \mid x^{(t)},  x^{(0)} \right)} \times \frac{q\!\left(x^{(t-1)} \mid x^{(0)}\right)}{q\!\left(x^{(t)} \mid  x^{(0)} \right)} \\
&= - H_p(x^{(T)}) +  \int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)} \right) \sum_{t=2}^{T} \log \frac{p\!\left(x^{(t-1)} \mid x^{(t)}\right)}{q\!\left(x^{(t-1)} \mid x^{(t)},  x^{(0)} \right)} + \int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)} \right)  \sum_{t=2}^{T} \log \frac{q\!\left(x^{(t-1)} \mid x^{(0)}\right)}{q\!\left(x^{(t)} \mid x^{(0)} \right)} \qquad (7)
\end{aligned}    \qquad (7) 
$$

The second term of equation (7) is 
$$
\begin{aligned}
&\int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)} \right)
  \sum_{t=2}^{T} \log
  \frac{p\!\left(x^{(t-1)} \mid x^{(t)}\right)}
       {q\!\left(x^{(t-1)} \mid x^{(t)}, x^{(0)} \right)} \\
&= - \sum_{t = 2}^{T} \int \mathrm{d}x^{(0)}\, \mathrm{d}x^{(t)} \,
   q\!\left(x^{(0)}, x^{(t)} \right)\,
   D_{\mathrm{KL}}\!\left(
   q\!\left(x^{(t-1)} \mid x^{(t)}, x^{(0)} \right)
   \,\middle\|\, 
   p\!\left(x^{(t-1)} \mid x^{(t)}\right)
   \right),
\end{aligned}     \qquad (8)
$$

and the third term of equation (7) is 

$$
\begin{aligned}
&\int \mathrm{d}x^{(0:T)}\, q\!\left(x^{(0:T)} \right)
  \sum_{t=2}^{T} \log
  \frac{q\!\left(x^{(t-1)} \mid x^{(0)}\right)}
       {q\!\left(x^{(t)} \mid x^{(0)}\right)} \\
&= \int \mathrm{d}x^{(0)}\,\mathrm{d}x^{(1)}\,
   q\!\left(x^{(0)},x^{(1)}\right)\, \log q\!\left(x^{(1)} \mid x^{(0)}\right)
 \;-\;
   \int \mathrm{d}x^{(0)}\,\mathrm{d}x^{(T)}\,
   q\!\left(x^{(0)},x^{(T)}\right)\, \log q\!\left(x^{(T)} \mid x^{(0)}\right) \\
&= - H_q\!\left(x^{(1)} \mid x^{(0)}\right)
   + H_q\!\left(x^{(T)} \mid x^{(0)}\right).
\end{aligned}      \qquad (9)
$$

Altogether, collecting equations (8) and (9), we have the ELBO for $\mathcal{L}$

$$
\mathcal{L} \ge
- \sum_{t = 2}^{T} \int \mathrm{d}x^{(0)}\, \mathrm{d}x^{(t)} \,
   q\!\left(x^{(0)}, x^{(t)} \right)\,
   D_{\mathrm{KL}}\!\left(
     q\!\left(x^{(t-1)} \mid x^{(t)}, x^{(0)} \right)
     \,\middle\|\,
     p\!\left(x^{(t-1)} \mid x^{(t)}\right)
   \right)
+ H_q\!\left(x^{(T)} \mid x^{(0)}\right)
- H_q\!\left(x^{(1)} \mid x^{(0)}\right)
- H_q\!\left(x^{(T)}\right).
$$


